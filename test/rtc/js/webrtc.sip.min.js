(function(e){function t(e){var t=!1;callStats(e,function(e){Math.floor(1e3*e.calculation.videoSendPacketLoss)/10>5||Math.floor(1e3*e.calculation.audioSendPacketLoss)/10>5?t||(t=!0,M.toast({html:"网络不稳定",completeCallback:function(){setTimeout(function(){t=!1},27e3)}})):(Math.floor(1e3*e.calculation.videoSendPacketLoss)/10>10||Math.floor(1e3*e.calculation.audioSendPacketLoss)/10>10)&&(t||(t=!0,M.toast({html:"您的网络很差",completeCallback:function(){setTimeout(function(){t=!1},27e3)}})),v.sendInfo("text/plain","quality"));var n=`\n          <p>upload: <i>${Math.floor(e.bandwidth.uploadSpeed/1024)} KBps</i></p>\n          <p>download: <i>${Math.floor(e.bandwidth.downloadSpeed/1024)} KBps</i></p>\n          <p>resolutionUp: <i>${e.video.send.width} x ${e.video.send.height}</i></p>\n          <p>resolutionDn: <i>${e.video.recv.width} x ${e.video.recv.height}</i></p>\n          <p>send audio jitter: <i>${Math.floor(100*e.audio.send.jitter)/10}ms</i></p>\n          <p>send audio loss: <i>${Math.floor(1e3*e.calculation.audioSendPacketLoss)/10}%</i></p>\n          <p>send video jitter: <i>${Math.floor(100*e.video.send.jitter)/10}ms</i></p>\n          <p>send video loss: <i>${Math.floor(1e3*e.calculation.videoSendPacketLoss)/10}%</i></p>\n\n          <p>recv audio jitter: <i>${Math.floor(100*e.audio.recv.jitter)/10}ms</i></p>\n          <p>recv audio loss: <i>${Math.floor(1e3*e.calculation.audioRecvPacketLoss)/10}%</i></p>\n          <p>recv video loss: <i>${Math.floor(1e3*e.calculation.videoRecvPacketLoss)/10}%</i></p>\n          <p>quality reason: <i>${e.video.send.qualityLimitationReason}</i></p>\n          <p>send fps: <i>${e.calculation.sendFPS}</i></p>\n          <p>recv fps: <i>${e.calculation.recvFPS}</i></p>\n        `;document.querySelector("#debug").innerHTML=n},5)}function n(e,t){const n=new AudioContext;let o=n.createMediaStreamSource(e),a=n.createScriptProcessor(4096,1,1);o.connect(a),a.connect(n.destination),a.onaudioprocess=(e=>{const n=e.inputBuffer.getChannelData(0),o=Math.max(...n),a=Math.round(100*o);t&&t(a>10?a:10)})}function o(e){var t=!1;e<0&&(t=!0,e=Math.abs(e));var n=parseInt(e),o=0,a=0;n>=60&&(o=parseInt(n/60),n=parseInt(n%60),o>=60&&(a=parseInt(o/60),o=parseInt(o%60)));var i=parseInt(n)+"秒";return o>0&&(i=parseInt(o)+"分"+i),a>0&&(i=parseInt(a)+"小时"+i),t?"-"+i:i}function a(){var e=document.querySelector("#localVideo").srcObject,t=document.querySelector("#remoteVideo").srcObject;C&&C.getTracks().forEach(e=>e.stop()),P&&P.getTracks().forEach(e=>e.stop()),e&&(e.getTracks().forEach(e=>e.stop()),e=null),t&&(t.getTracks().forEach(e=>e.stop()),t=null)}function i(e){"outgoing"===e.direction?(document.querySelector("#ringback").pause(),document.querySelector("#ringback").currentTime=0):(document.querySelector("#ringing").pause(),document.querySelector("#ringing").currentTime=0)}function c(e){_PeerConnection=e.connection,P=new MediaStream,_PeerConnection.getSenders().forEach(function(e){P.addTrack(e.track)}),C=new MediaStream,_PeerConnection.getReceivers().forEach(function(e){C.addTrack(e.track)}),P&&(n(P,e=>{$(".volStatus").width(e+"%")}),document.querySelector("#localVideo").srcObject=P),C&&(document.querySelector("#remoteVideo").srcObject=C),_PeerConnection.addEventListener("addstream",function(e){document.querySelector("#remoteVideo").srcObject=e.stream}),$(".session-timer").html(""),clearInterval(w),q=0,w=setInterval(function(){q++,$(".session-timer").html(o(q))},1e3),y.changePage("session"),t(_PeerConnection)}function r(e){if(!e)return;const t=_PeerConnection.getSenders();var n=e.speed,o=e.priority,a=e.constraints,i=e.constraints.frameRate;t.forEach(e=>{const t=e.getParameters();t.encodings||(t.encodings=[{}]),e.track.applyConstraints(a),"video"==e.track.kind?(t.encodings[0].maxBitrate=n,t.encodings[0].maxFramerate=i,t.encodings[0].networkPriority=o,t.encodings[0].priority=o):"audio"==e.track.kind&&(t.encodings[0].maxBitrate=n/2),e.setParameters(t).catch(e=>console.error(e)),console.log(e.getParameters())})}function s(e){if("请选择"==e)return;const t=_PeerConnection.getSenders(),n=1024e3;var o="high",a=n,i={low:{frameRate:{min:15,max:25},width:320,aspectRatio:1.3333333},medium:{frameRate:{min:15,max:25},width:640,aspectRatio:1.33333333},high:{frameRate:{min:15,max:25},width:1280,aspectRatio:1.77777777}};switch(e){case"low":a=n/2,o="low",i=i.low;break;case"medium":a=n,o="high",i=i.medium;break;case"high":a=2*n,o="high",i=i.high}t.forEach(e=>{const t=e.getParameters();t.encodings||(t.encodings=[{}]),e.track.applyConstraints(i),"video"==e.track.kind?(t.encodings[0].maxBitrate=a,t.encodings[0].maxFramerate=20,t.encodings[0].networkPriority=o,t.encodings[0].priority=o):"audio"==e.track.kind&&(t.encodings[0].maxBitrate=n/2),e.setParameters(t).catch(e=>console.error(e)),console.log(e.getParameters())})}function l(e){["connecting","connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage"].map(t=>{e.ua.on(t,function(e){console.log(`UAEvent: ${t}`,e)})})}function u(e){["peerconnection","connecting","sending","progress","accepted","confirmed","ended","failed","newDTMF","newInfo","hold","unhold","muted","unmuted","reinvite","update","refer","replaces","sdp","icecandidate","getusermediafailed","peerconnection:createofferfailed","peerconnection:createanswerfailed","peerconnection:setlocaldescriptionfailed","peerconnection:setremotedescriptionfailed"].map(t=>{e.on(t,function(e){console.info(`RTCSessionEvent: ${t}`,e)})})}function d(e){Object.keys(_).map(t=>{e.ua.on(t,function(e){_[t](e)})})}function p(e,t){Object.keys(j).map(n=>{e.on(n,function(o){j[n](o,e,t)})})}function m(e){document.querySelector("#localVideo").srcObject=e,document.querySelector("#localVideo").play()}function f(t){var n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),o=e.location.search.substr(1).match(n);return null!=o?unescape(o[2]):null}function h(e={}){this.account=e.account||" ",this.password=e.password||" ",this.domain=e.domain||" ",this.wss=e.wss||" ",this.socket=new FlyInnWeb.WebSocketInterface(this.wss),this.configuration={sockets:[this.socket],uri:"sip:"+this.account+"@"+this.domain,contact_uri:"sip:"+this.account+"@"+this.account+".invalid;transport=ws",password:this.password,display_name:this.account,session_timers:!1,register:!0},this.ua=new FlyInnWeb.UA(this.configuration)}var g=e.App||{},y=e.App.common,v=null,k=null,S=null;e._PeerConnection=null;var w,P=null,C=null,b=null,T={busy:{status_code:486},reject:{status_code:403}},q=0,I=!1,_={registered:function(e){y.changePage("main")},registrationFailed:function(e){v||y.changePage("login"),"Connection Error"!=e.cause?M.toast({html:"注册失败，请检查用户名或密码"}):M.toast({html:"网络连接错误,请检查网络信号"})},newRTCSession:function(e){if(S=e.session,"remote"===e.originator){if(v||k)return console.warn('incoming call replied with 486 "Busy Here"'),void e.session.terminate(T.busy);k=e.session}u(e.session),p(e.session,e)},newMessage:function(e){}},j={progress:function(e,t,n){"outgoing"===t.direction?(y.changePage("calling"),document.querySelector("#ringback").play()):(document.querySelector("#display-name").innerHTML=n.request.from.display_name,document.querySelector("#caller").innerHTML=n.request.from.display_name,y.changePage("incoming"),document.querySelector("#ringing").play())},sdp:function(e){},failed:function(e,t,n){v=null,k=null,i(t),y.changePage("main"),a(),b&&b.nomore(),"Request Timeout"==e.cause&&M.toast({html:"请求超时，请检查网络"}),"Connection Error"==e.cause&&M.toast({html:"连接错误，请检查网络"}),"Incompatible SDP"==e.cause&&M.toast({html:"不兼容的SDP"}),"remote"==e.originator?("Timeout"==e.message.reason_phrase&&M.toast({html:"呼叫超时"}),"Unavailable"==e.cause&&"Request Timeout"===e.message.reason_phrase&&M.toast({html:"呼叫超时，对方未接听"}),"Canceled"==e.cause&&M.toast({html:"用户取消呼叫"}),"Busy"==e.cause&&M.toast({html:"被叫忙"}),"Not Found"==e.cause&&M.toast({html:"用户不存在"}),"Rejected"==e.cause&&M.toast({html:"对方已拒绝"}),"SIP Failure Code"==e.cause&&M.toast({html:"SIP Failure Code"})):("No Answer"==e.cause&&M.toast({html:"呼叫未接听"}),"Canceled"==e.cause&&M.toast({html:"已取消呼叫"}),"Rejected"==e.cause&&M.toast({html:"已拒绝"}))},accepted:function(e,t,n){v=t,i(t),c(t)},ended:function(e,t,n){v=null,k=null,a(),y.changePage("main"),"Terminated"!=e.cause?M.toast({html:e.cause}):M.toast({html:"通话结束"})},getusermediafailed:function(){M.toast({html:"获取媒体设备失败，请检查权限"})},newInfo:function(e){if("remote"==e.originator)switch(e.request.body){case"setRemoteControl":$(".remoteControl").hide();break;case"cancelRemoteControl":$(".remoteControl").show();break;case"setMic":document.querySelector("#toggle-microphone").click();break;case"setVideo":document.querySelector("#toggle-camera").click();break;case"closeMic":$(".mic_btn").addClass("off");break;case"openMic":$(".mic_btn").removeClass("off");break;case"closeCam":$(".video_btn").addClass("off");break;case"openCam":$(".video_btn").removeClass("off");break;case"closeSpeaker":M.toast({html:"对方已关闭扬声器"});break;case"quality":I||(I=!0,M.toast({html:"对方的网络很差，会影响通话体验",completeCallback:function(){I=!1}}))}}},R={h264:["H264","VP9","VP8"],vp8:["VP8","H264","VP9"],vp9:["VP9","VP8","H264"]},x={tcp:"turn:lccsp.zgpajf.com.cn:9005?transport=tcp",udp:"turn:lccsp.zgpajf.com.cn:10001"};h.prototype.connect=function(){this.ua.start(),l(this),d(this)},h.prototype.unregister=function(){this.ua.isRegistered()&&this.ua.unregister()},h.prototype.call=function(e){$(".remoteControl").show(),$(".mic_btn").removeClass("off"),this.session=this.ua.call("sip:"+e+"@"+this.domain,{extraHeaders:["X-Token: 2c8a1be510764ad222ebcc4ffd0f9775"],mediaConstraints:{audio:!0,video:!0},pcConfig:f("transport")?{iceServers:[{urls:x[f("transport")],username:"user",credential:"password"}],iceTransportPolicy:"relay"}:{},videoPayloads:f("payload")?R[f("payload")]:[]})},h.prototype.answer=function(){k.answer({pcConfig:f("transport")?{iceServers:[{urls:x[f("transport")],username:"user",credential:"password"}],iceTransportPolicy:"relay"}:{}})},h.prototype.cancel=function(){S.terminate()},h.prototype.reject=function(){k.terminate(T.reject)},h.prototype.hangup=function(){v&&v.terminate()},h.prototype.testUpdate=function(e){r(e)},h.prototype.updateConstraints=function(e){s(e)},h.prototype.closeSpeaker=function(){v.sendInfo("text/plain","closeSpeaker"),M.toast({html:"您已关闭扬声器"})},h.prototype.closeMic=function(){v.sendInfo("text/plain","closeMic"),M.toast({html:"您已关闭麦克风"}),v&&v.mute({audio:!0})},h.prototype.openMic=function(){v.sendInfo("text/plain","openMic"),v&&v.unmute({audio:!0})},h.prototype.closeCam=function(){v.sendInfo("text/plain","closeCam"),M.toast({html:"您已关闭摄像头"}),v&&v.mute({video:!0})},h.prototype.openCam=function(){v.sendInfo("text/plain","openCam"),v&&v.unmute({video:!0})},h.prototype.sendDTMF=function(e){v&&v.sendDTMF(e)},h.prototype.sendInfo=function(e,t){v&&(t?v.sendInfo(t,e):v.sendInfo("application/json",e))},h.prototype.switchCam=function(){const e=v.switchVideoStream();e&&e.then(e=>{n(e,e=>{$(".volStatus").width(e+"%")}),document.querySelector("#localVideo").srcObject=e})},h.prototype.switchStream=function(t,n){var o=null;"screen"===n?(e.screenStream=t,o=t):t?(o=t,e.stream=t):o=e.stream,v&&_PeerConnection&&(m(o),"screen"===n&&(e.stream=_PeerConnection.getLocalStreams()[0]),o.getVideoTracks().forEach(function(e){var t=_PeerConnection.getSenders().find(function(t){return t.track.kind==e.kind});t.replaceTrack(e)}))},g.WebRTC=h,e.App=g})(window);