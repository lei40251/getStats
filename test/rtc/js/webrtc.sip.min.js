(function(e){function t(e){var t=!1;e<0&&(t=!0,e=Math.abs(e));var n=parseInt(e),o=0,s=0;n>=60&&(o=parseInt(n/60),n=parseInt(n%60),o>=60&&(s=parseInt(o/60),o=parseInt(o%60)));var i=parseInt(n)+"秒";return o>0&&(i=parseInt(o)+"分"+i),s>0&&(i=parseInt(s)+"小时"+i),t?"-"+i:i}function n(){var e=document.querySelector("#remoteAudio").srcObject;y&&y.getTracks().forEach(e=>e.stop()),g&&g.getTracks().forEach(e=>e.stop()),e&&(e.getTracks().forEach(e=>e.stop()),e=null)}function o(e){"outgoing"===e.direction?(document.querySelector("#ringback").pause(),document.querySelector("#ringback").currentTime=0):(document.querySelector("#ringing").pause(),document.querySelector("#ringing").currentTime=0)}function s(e){_PeerConnection=e.connection,y=new MediaStream,_PeerConnection.getReceivers().forEach(function(e){y.addTrack(e.track)}),y&&(document.querySelector("#remoteAudio").srcObject=y),_PeerConnection.addEventListener("addstream",function(e){document.querySelector("#remoteAudio").srcObject=e.stream}),$(".session-timer").html(""),clearInterval(h),S=0,h=setInterval(function(){S++,$(".session-timer").html(t(S))},1e3),d.changePage("session")}function i(e){["connecting","connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage"].map(t=>{e.ua.on(t,function(e){console.log(`UAEvent: ${t}`,e)})})}function a(e){["peerconnection","connecting","sending","progress","accepted","confirmed","ended","failed","newDTMF","newInfo","hold","unhold","muted","unmuted","reinvite","update","refer","replaces","sdp","icecandidate","getusermediafailed","peerconnection:createofferfailed","peerconnection:createanswerfailed","peerconnection:setlocaldescriptionfailed","peerconnection:setremotedescriptionfailed"].map(t=>{e.on(t,function(e){console.info(`RTCSessionEvent: ${t}`,e)})})}function c(e){Object.keys(b).map(t=>{e.ua.on(t,function(e){b[t](e)})})}function r(e,t){Object.keys(T).map(n=>{e.on(n,function(o){T[n](o,e,t)})})}function u(e={}){this.account=e.account||" ",this.password=e.password||" ",this.domain=e.domain||" ",this.wss=e.wss||" ",this.socket=new FlyInnWeb.WebSocketInterface(this.wss),this.configuration={sockets:[this.socket],uri:"sip:"+this.account+"@"+this.domain,contact_uri:"sip:"+this.account+"@"+this.account+".invalid;transport=ws",password:this.password,display_name:this.account},this.ua=new FlyInnWeb.UA(this.configuration)}var l=e.App||{},d=e.App.common,p=null,m=null,f=null;e._PeerConnection=null;var h,g=null,y=null,w=null,I={busy:{status_code:486},reject:{status_code:403}},S=0,b={registered:function(e){d.changePage("main")},registrationFailed:function(e){p||d.changePage("login"),"Connection Error"!=e.cause?M.toast({html:"注册失败，请检查用户名或密码"}):M.toast({html:"网络连接错误,请检查网络信号"})},newRTCSession:function(e){if(f=e.session,"remote"===e.originator){if(p||m)return console.warn('incoming call replied with 486 "Busy Here"'),void e.session.terminate(I.busy);m=e.session}a(e.session),r(e.session,e)},newMessage:function(e){}},T={progress:function(e,t,n){"outgoing"===t.direction?(d.changePage("calling"),document.querySelector("#ringback").play()):(document.querySelector("#display-name").innerHTML=n.request.from.display_name,d.changePage("incoming"),document.querySelector("#ringing").play())},failed:function(e,t,s){p=null,m=null,o(t),d.changePage("main"),n(),w&&w.nomore(),"Request Timeout"==e.cause&&M.toast({html:"请求超时，请检查网络"}),"Connection Error"==e.cause&&M.toast({html:"连接错误，请检查网络"}),"Incompatible SDP"==e.cause&&M.toast({html:"不兼容的SDP"}),"remote"==e.originator?("Timeout"==e.message.reason_phrase&&M.toast({html:"呼叫超时"}),"Unavailable"==e.cause&&"Request Timeout"===e.message.reason_phrase&&M.toast({html:"呼叫超时，对方未接听"}),"Canceled"==e.cause&&M.toast({html:"用户取消呼叫"}),"Busy"==e.cause&&M.toast({html:"被叫忙"}),"Not Found"==e.cause&&M.toast({html:"用户不存在"}),"Rejected"==e.cause&&M.toast({html:"对方已拒绝"}),"SIP Failure Code"==e.cause&&M.toast({html:"SIP Failure Code"})):("No Answer"==e.cause&&M.toast({html:"呼叫未接听"}),"Canceled"==e.cause&&M.toast({html:"已取消呼叫"}),"Rejected"==e.cause&&M.toast({html:"已拒绝"}))},accepted:function(e,t,n){p=t,o(t),s(t)},ended:function(e,t,o){p=null,m=null,n(),d.changePage("main"),"Terminated"!=e.cause?M.toast({html:e.cause}):M.toast({html:"通话结束"})},getusermediafailed:function(){M.toast({html:"获取媒体设备失败，请检查权限"})}};u.prototype.connect=function(){this.ua.start(),i(this),c(this)},u.prototype.unregister=function(){this.ua.isRegistered()&&this.ua.unregister()},u.prototype.call=function(e){$(".remoteControl").show(),$(".mic_btn").removeClass("off"),this.session=this.ua.call("sip:"+e+"@"+this.domain,{extraHeaders:["X-Token: 2c8a1be510764ad222ebcc4ffd0f9775"]})},u.prototype.answer=function(){m.answer()},u.prototype.cancel=function(){f.terminate()},u.prototype.reject=function(){m.terminate(I.reject)},u.prototype.hangup=function(){p&&p.terminate()},u.prototype.closeSpeaker=function(){p.sendInfo("text/plain","closeSpeaker"),M.toast({html:"您已关闭扬声器"})},u.prototype.closeMic=function(){p.sendInfo("text/plain","closeMic"),M.toast({html:"您已关闭麦克风"}),p&&p.mute({audio:!0})},u.prototype.openMic=function(){p.sendInfo("text/plain","openMic"),p&&p.unmute({audio:!0})},u.prototype.sendDTMF=function(e){p&&p.sendDTMF(e,{transportType:"RFC2833"})},u.prototype.sendInfo=function(e,t){p&&(t?p.sendInfo(t,e):p.sendInfo("application/json",e))},l.WebRTC=u,e.App=l})(window);