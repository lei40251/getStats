(function(e){function t(e){var t=!1;callStats(e,function(e){Math.floor(1e3*e.calculation.videoSendPacketLoss)/10>5||Math.floor(1e3*e.calculation.audioSendPacketLoss)/10>5?t||(t=!0,M.toast({html:"网络不稳定",completeCallback:function(){setTimeout(function(){t=!1},27e3)}})):(Math.floor(1e3*e.calculation.videoSendPacketLoss)/10>10||Math.floor(1e3*e.calculation.audioSendPacketLoss)/10>10)&&(t||(t=!0,M.toast({html:"您的网络很差",completeCallback:function(){setTimeout(function(){t=!1},27e3)}})),y.sendInfo("text/plain","quality"));var o=`\n          <p>upload: <i>${Math.floor(e.bandwidth.uploadSpeed/1024)} KBps</i></p>\n          <p>download: <i>${Math.floor(e.bandwidth.downloadSpeed/1024)} KBps</i></p>\n          <p>resolutionUp: <i>${e.video.send.width} x ${e.video.send.height}</i></p>\n          <p>resolutionDn: <i>${e.video.recv.width} x ${e.video.recv.height}</i></p>\n          <p>send audio jitter: <i>${Math.floor(100*e.audio.send.jitter)/10}ms</i></p>\n          <p>send audio loss: <i>${Math.floor(1e3*e.calculation.audioSendPacketLoss)/10}%</i></p>\n          <p>send video jitter: <i>${Math.floor(100*e.video.send.jitter)/10}ms</i></p>\n          <p>send video loss: <i>${Math.floor(1e3*e.calculation.videoSendPacketLoss)/10}%</i></p>\n\n          <p>recv audio jitter: <i>${Math.floor(100*e.audio.recv.jitter)/10}ms</i></p>\n          <p>recv audio loss: <i>${Math.floor(1e3*e.calculation.audioRecvPacketLoss)/10}%</i></p>\n          <p>recv video loss: <i>${Math.floor(1e3*e.calculation.videoRecvPacketLoss)/10}%</i></p>\n          <p>quality reason: <i>${e.video.send.qualityLimitationReason}</i></p>\n          <p>send fps: <i>${e.calculation.sendFPS}</i></p>\n          <p>recv fps: <i>${e.calculation.recvFPS}</i></p>\n        `;document.querySelector("#debug").innerHTML=o},5)}function o(e,t){const o=new AudioContext;let n=o.createMediaStreamSource(e),a=o.createScriptProcessor(4096,1,1);n.connect(a),a.connect(o.destination),a.onaudioprocess=(e=>{const o=e.inputBuffer.getChannelData(0),n=Math.max(...o),a=Math.round(100*n);t&&t(a>10?a:10)})}function n(e){var t=!1;e<0&&(t=!0,e=Math.abs(e));var o=parseInt(e),n=0,a=0;o>=60&&(n=parseInt(o/60),o=parseInt(o%60),n>=60&&(a=parseInt(n/60),n=parseInt(n%60)));var i=parseInt(o)+"秒";return n>0&&(i=parseInt(n)+"分"+i),a>0&&(i=parseInt(a)+"小时"+i),t?"-"+i:i}function a(){var e=document.querySelector("#localVideo").srcObject,t=document.querySelector("#remoteVideo").srcObject;P&&P.getTracks().forEach(e=>e.stop()),C&&C.getTracks().forEach(e=>e.stop()),e&&(e.getTracks().forEach(e=>e.stop()),e=null),t&&(t.getTracks().forEach(e=>e.stop()),t=null)}function i(e){"outgoing"===e.direction?(document.querySelector("#ringback").pause(),document.querySelector("#ringback").currentTime=0):(document.querySelector("#ringing").pause(),document.querySelector("#ringing").currentTime=0)}function r(e){if(_PeerConnection=e.connection,C=new MediaStream,_PeerConnection.getSenders().forEach(function(e){C.addTrack(e.track)}),P=new MediaStream,_rAudio=new MediaStream,_PeerConnection.getReceivers().forEach(function(e){"video"===e.track.kind?P.addTrack(e.track):"audio"===e.track.kind&&(P.addTrack(e.track),_rAudio.addTrack(e.track))}),C&&(o(C,e=>{$(".volStatus").width(e+"%")}),document.querySelector("#localVideo").srcObject=C),P){document.querySelector("#remoteVideo").srcObject=P;var a=new AudioContext,i=a.createMediaStreamSource(_rAudio),r=a.createBiquadFilter();r.type="lowshelf",r.frequency.value=1e3,r.gain.value=10,i.connect(r),r.connect(a.destination)}"remote"==g&&(videos=[C,P],recorder=new MultiStreamRecorder(videos,{video:{width:640,height:480}}),recorder.mimeType="video/webm;codecs=vp8",recorder.ondataavailable=function(e){db.video_record.add({sessionId:"test002",time:(new Date).getTime(),stream:e}).catch(function(e){alert("Error: "+(e.stack||e))})},recorder.start(1e4)),_PeerConnection.addEventListener("addstream",function(e){document.querySelector("#remoteVideo").srcObject=e.stream}),$(".session-timer").html(""),clearInterval(b),q=0,b=setInterval(function(){q++,$(".session-timer").html(n(q))},1e3),k.changePage("session"),t(_PeerConnection)}function c(e){if(!e)return;const t=_PeerConnection.getSenders();var o=e.speed,n=e.priority,a=e.constraints,i=e.constraints.frameRate;t.forEach(e=>{const t=e.getParameters();t.encodings||(t.encodings=[{}]),e.track.applyConstraints(a),"video"==e.track.kind?(t.encodings[0].maxBitrate=o,t.encodings[0].maxFramerate=i,t.encodings[0].networkPriority=n,t.encodings[0].priority=n):"audio"==e.track.kind&&(t.encodings[0].maxBitrate=o/2),e.setParameters(t).catch(e=>console.error(e)),console.log(e.getParameters())})}function s(e){if("请选择"==e)return;const t=_PeerConnection.getSenders(),o=1024e3;var n="high",a=o,i={low:{frameRate:{min:15,max:25},width:320,aspectRatio:1.3333333},medium:{frameRate:{min:15,max:25},width:640,aspectRatio:1.33333333},high:{frameRate:{min:15,max:25},width:1280,aspectRatio:1.77777777}};switch(e){case"low":a=o/2,n="low",i=i.low;break;case"medium":a=o,n="high",i=i.medium;break;case"high":a=2*o,n="high",i=i.high}t.forEach(e=>{const t=e.getParameters();t.encodings||(t.encodings=[{}]),e.track.applyConstraints(i),"video"==e.track.kind?(t.encodings[0].maxBitrate=a,t.encodings[0].maxFramerate=20,t.encodings[0].networkPriority=n,t.encodings[0].priority=n):"audio"==e.track.kind&&(t.encodings[0].maxBitrate=o/2),e.setParameters(t).catch(e=>console.error(e)),console.log(e.getParameters())})}function d(e){["connecting","connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage"].map(t=>{e.ua.on(t,function(e){console.log(`UAEvent: ${t}`,e)})})}function l(e){["peerconnection","connecting","sending","progress","accepted","confirmed","ended","failed","newDTMF","newInfo","hold","unhold","muted","unmuted","reinvite","update","refer","replaces","sdp","icecandidate","getusermediafailed","peerconnection:createofferfailed","peerconnection:createanswerfailed","peerconnection:setlocaldescriptionfailed","peerconnection:setremotedescriptionfailed"].map(t=>{e.on(t,function(e){console.info(`RTCSessionEvent: ${t}`,e)})})}function u(e){Object.keys(R).map(t=>{e.ua.on(t,function(e){R[t](e)})})}function p(e,t){Object.keys(j).map(o=>{e.on(o,function(n){j[o](n,e,t)})})}function m(e){document.querySelector("#localVideo").srcObject=e,document.querySelector("#localVideo").play()}function f(t){var o=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),n=e.location.search.substr(1).match(o);return null!=n?unescape(n[2]):null}function h(e={}){this.account=e.account||" ",this.password=e.password||" ",this.domain=e.domain||" ",this.wss=e.wss||" ",this.socket=new FlyInnWeb.WebSocketInterface(this.wss),this.configuration={sockets:[this.socket],uri:"sip:"+this.account+"@"+this.domain,contact_uri:"sip:"+this.account+"@"+this.account+".invalid;transport=ws",password:this.password,display_name:this.account,session_timers:!1,register:!0},this.ua=new FlyInnWeb.UA(this.configuration)}var g,v=e.App||{},k=e.App.common,y=null,w=null,S=null;e._PeerConnection=null;var b,C=null,P=null,T=null,_={busy:{status_code:486},reject:{status_code:403}},q=0,I=!1,R={registered:function(e){k.changePage("main")},registrationFailed:function(e){y||k.changePage("login"),"Connection Error"!=e.cause?M.toast({html:"注册失败，请检查用户名或密码"}):M.toast({html:"网络连接错误,请检查网络信号"})},newRTCSession:function(e){if(g=e.originator,S=e.session,"remote"===e.originator){if(y||w)return console.warn('incoming call replied with 486 "Busy Here"'),void e.session.terminate(_.busy);w=e.session}l(e.session),p(e.session,e)},newMessage:function(e){}},j={progress:function(e,t,o){"outgoing"===t.direction?(k.changePage("calling"),document.querySelector("#ringback").play()):(document.querySelector("#display-name").innerHTML=o.request.from.display_name,document.querySelector("#caller").innerHTML=o.request.from.display_name,k.changePage("incoming"),document.querySelector("#ringing").play())},sdp:function(e){},failed:function(e,t,o){y=null,w=null,i(t),k.changePage("main"),a(),T&&T.nomore(),"Request Timeout"==e.cause&&M.toast({html:"请求超时，请检查网络"}),"Connection Error"==e.cause&&M.toast({html:"连接错误，请检查网络"}),"Incompatible SDP"==e.cause&&M.toast({html:"不兼容的SDP"}),"remote"==e.originator?("Timeout"==e.message.reason_phrase&&M.toast({html:"呼叫超时"}),"Unavailable"==e.cause&&"Request Timeout"===e.message.reason_phrase&&M.toast({html:"呼叫超时，对方未接听"}),"Canceled"==e.cause&&M.toast({html:"用户取消呼叫"}),"Busy"==e.cause&&M.toast({html:"被叫忙"}),"Not Found"==e.cause&&M.toast({html:"用户不存在"}),"Rejected"==e.cause&&M.toast({html:"对方已拒绝"}),"SIP Failure Code"==e.cause&&M.toast({html:"SIP Failure Code"})):("No Answer"==e.cause&&M.toast({html:"呼叫未接听"}),"Canceled"==e.cause&&M.toast({html:"已取消呼叫"}),"Rejected"==e.cause&&M.toast({html:"已拒绝"}))},accepted:function(e,t,o){y=t,i(t),r(t)},ended:function(e,t,o){y=null,w=null,a(),k.changePage("main"),"Terminated"!=e.cause?M.toast({html:e.cause}):M.toast({html:"通话结束"})},getusermediafailed:function(){M.toast({html:"获取媒体设备失败，请检查权限"})},newInfo:function(e){if("remote"==e.originator)switch(e.request.body){case"setRemoteControl":$(".remoteControl").hide();break;case"cancelRemoteControl":$(".remoteControl").show();break;case"setMic":document.querySelector("#toggle-microphone").click();break;case"setVideo":document.querySelector("#toggle-camera").click();break;case"closeMic":$(".mic_btn").addClass("off");break;case"openMic":$(".mic_btn").removeClass("off");break;case"closeCam":$(".video_btn").addClass("off");break;case"openCam":$(".video_btn").removeClass("off");break;case"closeSpeaker":M.toast({html:"对方已关闭扬声器"});break;case"quality":I||(I=!0,M.toast({html:"对方的网络很差，会影响通话体验",completeCallback:function(){I=!1}}))}}},x={tcp:"turn:lccsp.zgpajf.com.cn:9005?transport=tcp",udp:"turn:lccsp.zgpajf.com.cn:10001"};h.prototype.connect=function(){this.ua.start(),d(this),u(this)},h.prototype.unregister=function(){this.ua.isRegistered()&&this.ua.unregister()},h.prototype.call=function(e){$(".remoteControl").show(),$(".mic_btn").removeClass("off"),this.session=this.ua.call("sip:"+e+"@"+this.domain,{extraHeaders:["X-Token: 2c8a1be510764ad222ebcc4ffd0f9775"],mediaConstraints:{audio:!0,video:!0},video_first_codec:"vp8",pcConfig:f("transport")?{iceServers:[{urls:x[f("transport")],username:"user",credential:"password"}],iceTransportPolicy:"relay"}:{}})},h.prototype.answer=function(){w.answer({pcConfig:f("transport")?{iceServers:[{urls:x[f("transport")],username:"user",credential:"password"}],iceTransportPolicy:"relay"}:{}})},h.prototype.cancel=function(){S.terminate()},h.prototype.reject=function(){w.terminate(_.reject)},h.prototype.hangup=function(){y&&y.terminate()},h.prototype.testUpdate=function(e){c(e)},h.prototype.updateConstraints=function(e){s(e)},h.prototype.closeSpeaker=function(){y.sendInfo("text/plain","closeSpeaker"),M.toast({html:"您已关闭扬声器"})},h.prototype.closeMic=function(){y.sendInfo("text/plain","closeMic"),M.toast({html:"您已关闭麦克风"}),y&&y.mute({audio:!0})},h.prototype.openMic=function(){y.sendInfo("text/plain","openMic"),y&&y.unmute({audio:!0})},h.prototype.closeCam=function(){y.sendInfo("text/plain","closeCam"),M.toast({html:"您已关闭摄像头"}),y&&y.mute({video:!0})},h.prototype.openCam=function(){y.sendInfo("text/plain","openCam"),y&&y.unmute({video:!0})},h.prototype.sendDTMF=function(e){y&&y.sendDTMF(e)},h.prototype.sendInfo=function(e,t){y&&(t?y.sendInfo(t,e):y.sendInfo("application/json",e))},h.prototype.switchCam=function(){const e=y.switchVideoStream();e&&e.then(e=>{o(e,e=>{$(".volStatus").width(e+"%")}),document.querySelector("#localVideo").srcObject=e})},h.prototype.switchStream=function(t,o){var n=null;"screen"===o?(e.screenStream=t,n=t):t?(n=t,e.stream=t):n=e.stream,y&&_PeerConnection&&(m(n),"screen"===o&&(e.stream=_PeerConnection.getLocalStreams()[0]),n.getVideoTracks().forEach(function(e){var t=_PeerConnection.getSenders().find(function(t){return t.track.kind==e.kind});t.replaceTrack(e)}))},v.WebRTC=h,e.App=v})(window);