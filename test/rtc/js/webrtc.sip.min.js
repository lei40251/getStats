(function(e){function t(e){var t=!1;callStats(e,function(e){Math.floor(1e3*e.calculation.videoSendPacketLoss)/10>5||Math.floor(1e3*e.calculation.audioSendPacketLoss)/10>5?t||(t=!0,M.toast({html:"网络不稳定",completeCallback:function(){setTimeout(function(){t=!1},27e3)}})):(Math.floor(1e3*e.calculation.videoSendPacketLoss)/10>10||Math.floor(1e3*e.calculation.audioSendPacketLoss)/10>10)&&(t||(t=!0,M.toast({html:"您的网络很差",completeCallback:function(){setTimeout(function(){t=!1},27e3)}})),g.sendInfo("text/plain","quality"));var n=`\n          <p>upload: <i>${Math.floor(e.bandwidth.uploadSpeed/1024)} KBps</i></p>\n          <p>download: <i>${Math.floor(e.bandwidth.downloadSpeed/1024)} KBps</i></p>\n          <p>resolutionUp: <i>${e.video.send.width} x ${e.video.send.height}</i></p>\n          <p>resolutionDn: <i>${e.video.recv.width} x ${e.video.recv.height}</i></p>\n          <p>send audio jitter: <i>${Math.floor(100*e.audio.send.jitter)/10}ms</i></p>\n          <p>send audio loss: <i>${Math.floor(1e3*e.calculation.audioSendPacketLoss)/10}%</i></p>\n          <p>send video jitter: <i>${Math.floor(100*e.video.send.jitter)/10}ms</i></p>\n          <p>send video loss: <i>${Math.floor(1e3*e.calculation.videoSendPacketLoss)/10}%</i></p>\n\n          <p>recv audio jitter: <i>${Math.floor(100*e.audio.recv.jitter)/10}ms</i></p>\n          <p>recv audio loss: <i>${Math.floor(1e3*e.calculation.audioRecvPacketLoss)/10}%</i></p>\n          <p>recv video loss: <i>${Math.floor(1e3*e.calculation.videoRecvPacketLoss)/10}%</i></p>\n          <p>quality reason: <i>${e.video.send.qualityLimitationReason}</i></p>\n          <p>send fps: <i>${e.calculation.sendFPS}</i></p>\n          <p>recv fps: <i>${e.calculation.recvFPS}</i></p>\n        `;document.querySelector("#debug").innerHTML=n},5)}function n(e){var t=!1;e<0&&(t=!0,e=Math.abs(e));var n=parseInt(e),o=0,i=0;n>=60&&(o=parseInt(n/60),n=parseInt(n%60),o>=60&&(i=parseInt(o/60),o=parseInt(o%60)));var a=parseInt(n)+"秒";return o>0&&(a=parseInt(o)+"分"+a),i>0&&(a=parseInt(i)+"小时"+a),t?"-"+a:a}function o(){var e=document.querySelector("#localVideo").srcObject,t=document.querySelector("#remoteVideo").srcObject;w&&w.getTracks().forEach(e=>e.stop()),S&&S.getTracks().forEach(e=>e.stop()),e&&(e.getTracks().forEach(e=>e.stop()),e=null),t&&(t.getTracks().forEach(e=>e.stop()),t=null)}function i(e){"outgoing"===e.direction?(document.querySelector("#ringback").pause(),document.querySelector("#ringback").currentTime=0):(document.querySelector("#ringing").pause(),document.querySelector("#ringing").currentTime=0)}function a(e){_PeerConnection=e.connection,S=new MediaStream,_PeerConnection.getSenders().forEach(function(e){S.addTrack(e.track)}),w=new MediaStream,_PeerConnection.getReceivers().forEach(function(e){w.addTrack(e.track)}),S&&(document.querySelector("#localVideo").srcObject=S),w&&(document.querySelector("#remoteVideo").srcObject=w),_PeerConnection.addEventListener("addstream",function(e){document.querySelector("#remoteVideo").srcObject=e.stream}),$(".session-timer").html(""),clearInterval(v),C=0,v=setInterval(function(){C++,$(".session-timer").html(n(C))},1e3),f.changePage("session"),t(_PeerConnection)}function c(e){if(!e)return;const t=_PeerConnection.getSenders();var n=e.speed,o=e.priority,i=e.constraints,a=e.constraints.frameRate;t.forEach(e=>{const t=e.getParameters();t.encodings||(t.encodings=[{}]),e.track.applyConstraints(i),"video"==e.track.kind?(t.encodings[0].maxBitrate=n,t.encodings[0].maxFramerate=a,t.encodings[0].networkPriority=o,t.encodings[0].priority=o):"audio"==e.track.kind&&(t.encodings[0].maxBitrate=n/2),e.setParameters(t).catch(e=>console.error(e)),console.log(e.getParameters())})}function s(e){if("请选择"==e)return;const t=_PeerConnection.getSenders(),n=1024e3;var o="high",i=n,a={low:{frameRate:{min:15,max:25},width:320,aspectRatio:1.3333333},medium:{frameRate:{min:15,max:25},width:640,aspectRatio:1.33333333},high:{frameRate:{min:15,max:25},width:1280,aspectRatio:1.77777777}};switch(e){case"low":i=n/2,o="low",a=a.low;break;case"medium":i=n,o="high",a=a.medium;break;case"high":i=2*n,o="high",a=a.high}t.forEach(e=>{const t=e.getParameters();t.encodings||(t.encodings=[{}]),e.track.applyConstraints(a),"video"==e.track.kind?(t.encodings[0].maxBitrate=i,t.encodings[0].maxFramerate=20,t.encodings[0].networkPriority=o,t.encodings[0].priority=o):"audio"==e.track.kind&&(t.encodings[0].maxBitrate=n/2),e.setParameters(t).catch(e=>console.error(e)),console.log(e.getParameters())})}function r(e){["connecting","connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage"].map(t=>{e.ua.on(t,function(e){console.log(`UAEvent: ${t}`,e)})})}function l(e){["peerconnection","connecting","sending","progress","accepted","confirmed","ended","failed","newDTMF","newInfo","hold","unhold","muted","unmuted","reinvite","update","refer","replaces","sdp","icecandidate","getusermediafailed","peerconnection:createofferfailed","peerconnection:createanswerfailed","peerconnection:setlocaldescriptionfailed","peerconnection:setremotedescriptionfailed"].map(t=>{e.on(t,function(e){console.info(`RTCSessionEvent: ${t}`,e)})})}function u(e){Object.keys(T).map(t=>{e.ua.on(t,function(e){T[t](e)})})}function d(e,t){Object.keys(I).map(n=>{e.on(n,function(o){I[n](o,e,t)})})}function p(e){document.querySelector("#localVideo").srcObject=e,document.querySelector("#localVideo").play()}function m(e={}){this.account=e.account||" ",this.password=e.password||" ",this.domain=e.domain||" ",this.wss=e.wss||" ",this.socket=new FlyInnWeb.WebSocketInterface(this.wss),this.configuration={sockets:[this.socket],uri:"sip:"+this.account+"@"+this.domain,contact_uri:"sip:"+this.account+"@"+this.account+".invalid;transport=ws",password:this.password,display_name:this.account,register:!0},this.ua=new FlyInnWeb.UA(this.configuration)}var h=e.App||{},f=e.App.common,g=null,y=null,k=null;e._PeerConnection=null;var v,S=null,w=null,P=null,b={busy:{status_code:486},reject:{status_code:403}},C=0,q=!1,T={registered:function(e){f.changePage("main")},registrationFailed:function(e){f.changePage("login"),"Connection Error"!=e.cause?M.toast({html:"注册失败，请检查用户名或密码"}):M.toast({html:"网络连接错误,请检查网络信号"})},newRTCSession:function(e){if(k=e.session,"remote"===e.originator){if(g||y)return console.warn('incoming call replied with 486 "Busy Here"'),void e.session.terminate(b.busy);y=e.session}l(e.session),d(e.session,e)},newMessage:function(e){}},I={progress:function(e,t,n){"outgoing"===t.direction?(f.changePage("calling"),document.querySelector("#ringback").play()):(document.querySelector("#display-name").innerHTML=n.request.from.display_name,document.querySelector("#caller").innerHTML=n.request.from.display_name,f.changePage("incoming"),document.querySelector("#ringing").play())},failed:function(e,t,n){g=null,y=null,i(t),f.changePage("main"),o(),P&&P.nomore(),"Request Timeout"==e.cause&&M.toast({html:"请求超时，请检查网络"}),"Connection Error"==e.cause&&M.toast({html:"连接错误，请检查网络"}),"Incompatible SDP"==e.cause&&M.toast({html:"不兼容的SDP"}),"remote"==e.originator?("Timeout"==e.message.reason_phrase&&M.toast({html:"呼叫超时"}),"Unavailable"==e.cause&&"Request Timeout"===e.message.reason_phrase&&M.toast({html:"呼叫超时，对方未接听"}),"Canceled"==e.cause&&M.toast({html:"用户取消呼叫"}),"Busy"==e.cause&&M.toast({html:"被叫忙"}),"Not Found"==e.cause&&M.toast({html:"用户不存在"}),"Rejected"==e.cause&&M.toast({html:"对方已拒绝"}),"SIP Failure Code"==e.cause&&M.toast({html:"SIP Failure Code"})):("No Answer"==e.cause&&M.toast({html:"呼叫未接听"}),"Canceled"==e.cause&&M.toast({html:"已取消呼叫"}),"Rejected"==e.cause&&M.toast({html:"已拒绝"}))},accepted:function(e,t,n){g=t,i(t),a(t)},ended:function(e,t,n){g=null,y=null,o(),f.changePage("main"),"Terminated"!=e.cause?M.toast({html:e.cause}):M.toast({html:"通话结束"})},getusermediafailed:function(){M.toast({html:"获取媒体设备失败，请检查权限"})},newInfo:function(e){if("remote"==e.originator)switch(e.request.body){case"closeMic":M.toast({html:"对方已关闭麦克风"});break;case"closeCam":M.toast({html:"对方已关闭摄像头"});break;case"closeSpeaker":M.toast({html:"对方已关闭扬声器"});break;case"quality":q||(q=!0,M.toast({html:"对方的网络很差，会影响通话体验",completeCallback:function(){q=!1}}))}}};m.prototype.connect=function(){this.ua.start(),r(this),u(this)},m.prototype.unregister=function(){this.ua.isRegistered()&&this.ua.unregister()},m.prototype.call=function(e){this.session=this.ua.call("sip:"+e+"@"+this.domain,{extraHeaders:["X-Token: 2c8a1be510764ad222ebcc4ffd0f9775"],mediaConstraints:{audio:!0,video:!0}})},m.prototype.answer=function(){y.answer()},m.prototype.cancel=function(){k.terminate()},m.prototype.reject=function(){y.terminate(b.reject)},m.prototype.hangup=function(){g&&g.terminate()},m.prototype.testUpdate=function(e){c(e)},m.prototype.updateConstraints=function(e){s(e)},m.prototype.closeSpeaker=function(){g.sendInfo("text/plain","closeSpeaker"),M.toast({html:"您已关闭扬声器"})},m.prototype.closeMic=function(){g.sendInfo("text/plain","closeMic"),M.toast({html:"您已关闭麦克风"}),g&&g.mute({audio:!0})},m.prototype.openMic=function(){g&&g.unmute({audio:!0})},m.prototype.closeCam=function(){g.sendInfo("text/plain","closeCam"),M.toast({html:"您已关闭摄像头"}),g&&g.mute({video:!0})},m.prototype.openCam=function(){g&&g.unmute({video:!0})},m.prototype.sendDTMF=function(e){g&&g.sendDTMF(e)},m.prototype.sendInfo=function(e){g&&g.sendInfo("application/json",e)},m.prototype.switchCam=function(){const e=g.switchVideoStream();e&&e.then(e=>{document.querySelector("#localVideo").srcObject=e})},m.prototype.switchStream=function(t){e.stream=t,g&&_PeerConnection&&(_PeerConnection.getLocalStreams().forEach(e=>{_PeerConnection.removeStream(e)}),_PeerConnection.addStream(t),p(t),g.renegotiate())},h.WebRTC=m,e.App=h})(window);