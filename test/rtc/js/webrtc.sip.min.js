(function(e){function t(e){var t=!1;callStats(e,function(e){Math.floor(1e3*e.calculation.videoSendPacketLoss)/10>5||Math.floor(1e3*e.calculation.audioSendPacketLoss)/10>5?t||(t=!0,M.toast({html:"网络不稳定",completeCallback:function(){setTimeout(function(){t=!1},27e3)}})):(Math.floor(1e3*e.calculation.videoSendPacketLoss)/10>10||Math.floor(1e3*e.calculation.audioSendPacketLoss)/10>10)&&(t||(t=!0,M.toast({html:"您的网络很差",completeCallback:function(){setTimeout(function(){t=!1},27e3)}})),y.sendInfo("text/plain","quality"));var n=`\n          <p>upload: <i>${Math.floor(e.bandwidth.uploadSpeed/1024)} KBps</i></p>\n          <p>download: <i>${Math.floor(e.bandwidth.downloadSpeed/1024)} KBps</i></p>\n          <p>resolutionUp: <i>${e.video.send.width} x ${e.video.send.height}</i></p>\n          <p>resolutionDn: <i>${e.video.recv.width} x ${e.video.recv.height}</i></p>\n          <p>send audio jitter: <i>${Math.floor(100*e.audio.send.jitter)/10}ms</i></p>\n          <p>send audio loss: <i>${Math.floor(1e3*e.calculation.audioSendPacketLoss)/10}%</i></p>\n          <p>send video jitter: <i>${Math.floor(100*e.video.send.jitter)/10}ms</i></p>\n          <p>send video loss: <i>${Math.floor(1e3*e.calculation.videoSendPacketLoss)/10}%</i></p>\n\n          <p>recv audio jitter: <i>${Math.floor(100*e.audio.recv.jitter)/10}ms</i></p>\n          <p>recv audio loss: <i>${Math.floor(1e3*e.calculation.audioRecvPacketLoss)/10}%</i></p>\n          <p>recv video loss: <i>${Math.floor(1e3*e.calculation.videoRecvPacketLoss)/10}%</i></p>\n          <p>quality reason: <i>${e.video.send.qualityLimitationReason}</i></p>\n          <p>send fps: <i>${e.calculation.sendFPS}</i></p>\n          <p>recv fps: <i>${e.calculation.recvFPS}</i></p>\n        `;document.querySelector("#debug").innerHTML=n},5)}function n(e){var t=!1;e<0&&(t=!0,e=Math.abs(e));var n=parseInt(e),o=0,a=0;n>=60&&(o=parseInt(n/60),n=parseInt(n%60),o>=60&&(a=parseInt(o/60),o=parseInt(o%60)));var i=parseInt(n)+"秒";return o>0&&(i=parseInt(o)+"分"+i),a>0&&(i=parseInt(a)+"小时"+i),t?"-"+i:i}function o(){var e=document.querySelector("#localVideo").srcObject,t=document.querySelector("#remoteVideo").srcObject;P&&P.getTracks().forEach(e=>e.stop()),w&&w.getTracks().forEach(e=>e.stop()),e&&(e.getTracks().forEach(e=>e.stop()),e=null),t&&(t.getTracks().forEach(e=>e.stop()),t=null)}function a(e){"outgoing"===e.direction?(document.querySelector("#ringback").pause(),document.querySelector("#ringback").currentTime=0):(document.querySelector("#ringing").pause(),document.querySelector("#ringing").currentTime=0)}function i(e){_PeerConnection=e.connection,w=new MediaStream,_PeerConnection.getSenders().forEach(function(e){w.addTrack(e.track)}),P=new MediaStream,_PeerConnection.getReceivers().forEach(function(e){P.addTrack(e.track)}),w&&(document.querySelector("#localVideo").srcObject=w),P&&(document.querySelector("#remoteVideo").srcObject=P),_PeerConnection.addEventListener("addstream",function(e){document.querySelector("#remoteVideo").srcObject=e.stream}),$(".session-timer").html(""),clearInterval(S),q=0,S=setInterval(function(){q++,$(".session-timer").html(n(q))},1e3),g.changePage("session"),t(_PeerConnection)}function c(e){if(!e)return;const t=_PeerConnection.getSenders();var n=e.speed,o=e.priority,a=e.constraints,i=e.constraints.frameRate;t.forEach(e=>{const t=e.getParameters();t.encodings||(t.encodings=[{}]),e.track.applyConstraints(a),"video"==e.track.kind?(t.encodings[0].maxBitrate=n,t.encodings[0].maxFramerate=i,t.encodings[0].networkPriority=o,t.encodings[0].priority=o):"audio"==e.track.kind&&(t.encodings[0].maxBitrate=n/2),e.setParameters(t).catch(e=>console.error(e)),console.log(e.getParameters())})}function r(e){if("请选择"==e)return;const t=_PeerConnection.getSenders(),n=1024e3;var o="high",a=n,i={low:{frameRate:{min:15,max:25},width:320,aspectRatio:1.3333333},medium:{frameRate:{min:15,max:25},width:640,aspectRatio:1.33333333},high:{frameRate:{min:15,max:25},width:1280,aspectRatio:1.77777777}};switch(e){case"low":a=n/2,o="low",i=i.low;break;case"medium":a=n,o="high",i=i.medium;break;case"high":a=2*n,o="high",i=i.high}t.forEach(e=>{const t=e.getParameters();t.encodings||(t.encodings=[{}]),e.track.applyConstraints(i),"video"==e.track.kind?(t.encodings[0].maxBitrate=a,t.encodings[0].maxFramerate=20,t.encodings[0].networkPriority=o,t.encodings[0].priority=o):"audio"==e.track.kind&&(t.encodings[0].maxBitrate=n/2),e.setParameters(t).catch(e=>console.error(e)),console.log(e.getParameters())})}function s(e){["connecting","connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage"].map(t=>{e.ua.on(t,function(e){console.log(`UAEvent: ${t}`,e)})})}function l(e){["peerconnection","connecting","sending","progress","accepted","confirmed","ended","failed","newDTMF","newInfo","hold","unhold","muted","unmuted","reinvite","update","refer","replaces","sdp","icecandidate","getusermediafailed","peerconnection:createofferfailed","peerconnection:createanswerfailed","peerconnection:setlocaldescriptionfailed","peerconnection:setremotedescriptionfailed"].map(t=>{e.on(t,function(e){console.info(`RTCSessionEvent: ${t}`,e)})})}function u(e){Object.keys(I).map(t=>{e.ua.on(t,function(e){I[t](e)})})}function d(e,t){Object.keys(_).map(n=>{e.on(n,function(o){_[n](o,e,t)})})}function p(e){document.querySelector("#localVideo").srcObject=e,document.querySelector("#localVideo").play()}function m(t){var n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),o=e.location.search.substr(1).match(n);return null!=o?unescape(o[2]):null}function f(e={}){this.account=e.account||" ",this.password=e.password||" ",this.domain=e.domain||" ",this.wss=e.wss||" ",this.socket=new FlyInnWeb.WebSocketInterface(this.wss),this.configuration={sockets:[this.socket],uri:"sip:"+this.account+"@"+this.domain,contact_uri:"sip:"+this.account+"@"+this.account+".invalid;transport=ws",password:this.password,display_name:this.account,register:!0},this.ua=new FlyInnWeb.UA(this.configuration)}var h=e.App||{},g=e.App.common,y=null,k=null,v=null;e._PeerConnection=null;var S,w=null,P=null,b=null,C={busy:{status_code:486},reject:{status_code:403}},q=0,T=!1,I={registered:function(e){g.changePage("main")},registrationFailed:function(e){g.changePage("login"),"Connection Error"!=e.cause?M.toast({html:"注册失败，请检查用户名或密码"}):M.toast({html:"网络连接错误,请检查网络信号"})},newRTCSession:function(e){if(v=e.session,"remote"===e.originator){if(y||k)return console.warn('incoming call replied with 486 "Busy Here"'),void e.session.terminate(C.busy);k=e.session}l(e.session),d(e.session,e)},newMessage:function(e){}},_={progress:function(e,t,n){"outgoing"===t.direction?(g.changePage("calling"),document.querySelector("#ringback").play()):(document.querySelector("#display-name").innerHTML=n.request.from.display_name,document.querySelector("#caller").innerHTML=n.request.from.display_name,g.changePage("incoming"),document.querySelector("#ringing").play())},sdp:function(e){},failed:function(e,t,n){y=null,k=null,a(t),g.changePage("main"),o(),b&&b.nomore(),"Request Timeout"==e.cause&&M.toast({html:"请求超时，请检查网络"}),"Connection Error"==e.cause&&M.toast({html:"连接错误，请检查网络"}),"Incompatible SDP"==e.cause&&M.toast({html:"不兼容的SDP"}),"remote"==e.originator?("Timeout"==e.message.reason_phrase&&M.toast({html:"呼叫超时"}),"Unavailable"==e.cause&&"Request Timeout"===e.message.reason_phrase&&M.toast({html:"呼叫超时，对方未接听"}),"Canceled"==e.cause&&M.toast({html:"用户取消呼叫"}),"Busy"==e.cause&&M.toast({html:"被叫忙"}),"Not Found"==e.cause&&M.toast({html:"用户不存在"}),"Rejected"==e.cause&&M.toast({html:"对方已拒绝"}),"SIP Failure Code"==e.cause&&M.toast({html:"SIP Failure Code"})):("No Answer"==e.cause&&M.toast({html:"呼叫未接听"}),"Canceled"==e.cause&&M.toast({html:"已取消呼叫"}),"Rejected"==e.cause&&M.toast({html:"已拒绝"}))},accepted:function(e,t,n){y=t,a(t),i(t)},ended:function(e,t,n){y=null,k=null,o(),g.changePage("main"),"Terminated"!=e.cause?M.toast({html:e.cause}):M.toast({html:"通话结束"})},getusermediafailed:function(){M.toast({html:"获取媒体设备失败，请检查权限"})},newInfo:function(e){if("remote"==e.originator)switch(e.request.body){case"setRemoteControl":$(".remoteControl").hide();break;case"cancelRemoteControl":$(".remoteControl").show();break;case"setMic":document.querySelector("#toggle-microphone").click();break;case"setVideo":document.querySelector("#toggle-camera").click();break;case"closeMic":$(".mic_btn").addClass("off");break;case"openMic":$(".mic_btn").removeClass("off");break;case"closeCam":$(".video_btn").addClass("off");break;case"openCam":$(".video_btn").removeClass("off");break;case"closeSpeaker":M.toast({html:"对方已关闭扬声器"});break;case"quality":T||(T=!0,M.toast({html:"对方的网络很差，会影响通话体验",completeCallback:function(){T=!1}}))}}},j={h264:["H264","VP9","VP8"],vp8:["VP8","H264","VP9"],vp9:["VP9","VP8","H264"]},R={tcp:"turn:lccsp.zgpajf.com.cn:9005?transport=tcp",udp:"turn:lccsp.zgpajf.com.cn:10001"};f.prototype.connect=function(){this.ua.start(),s(this),u(this)},f.prototype.unregister=function(){this.ua.isRegistered()&&this.ua.unregister()},f.prototype.call=function(e){$(".remoteControl").show(),$(".mic_btn").removeClass("off"),this.session=this.ua.call("sip:"+e+"@"+this.domain,{extraHeaders:["X-Token: 2c8a1be510764ad222ebcc4ffd0f9775"],mediaConstraints:{audio:!0,video:!0},pcConfig:m("transport")?{iceServers:[{urls:R[m("transport")],username:"user",credential:"password"}],iceTransportPolicy:"relay"}:{},videoPayloads:m("payload")?j[m("payload")]:[]})},f.prototype.answer=function(){k.answer()},f.prototype.cancel=function(){v.terminate()},f.prototype.reject=function(){k.terminate(C.reject)},f.prototype.hangup=function(){y&&y.terminate()},f.prototype.testUpdate=function(e){c(e)},f.prototype.updateConstraints=function(e){r(e)},f.prototype.closeSpeaker=function(){y.sendInfo("text/plain","closeSpeaker"),M.toast({html:"您已关闭扬声器"})},f.prototype.closeMic=function(){y.sendInfo("text/plain","closeMic"),M.toast({html:"您已关闭麦克风"}),y&&y.mute({audio:!0})},f.prototype.openMic=function(){y.sendInfo("text/plain","openMic"),y&&y.unmute({audio:!0})},f.prototype.closeCam=function(){y.sendInfo("text/plain","closeCam"),M.toast({html:"您已关闭摄像头"}),y&&y.mute({video:!0})},f.prototype.openCam=function(){y.sendInfo("text/plain","openCam"),y&&y.unmute({video:!0})},f.prototype.sendDTMF=function(e){y&&y.sendDTMF(e)},f.prototype.sendInfo=function(e,t){y&&(t?y.sendInfo(t,e):y.sendInfo("application/json",e))},f.prototype.switchCam=function(){const e=y.switchVideoStream();e&&e.then(e=>{document.querySelector("#localVideo").srcObject=e})},f.prototype.switchStream=function(t,n){var o=null;"screen"===n?(e.screenStream=t,o=t):t?(o=t,e.stream=t):o=e.stream,y&&_PeerConnection&&(p(o),"screen"===n&&(e.stream=_PeerConnection.getLocalStreams()[0]),o.getVideoTracks().forEach(function(e){var t=_PeerConnection.getSenders().find(function(t){return t.track.kind==e.kind});t.replaceTrack(e)}))},h.WebRTC=f,e.App=h})(window);